variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_SUBMODULE_FORCE_HTTPS: "true"


stages:
  - prepare
  - build
  - release

#
# Parepare variables
#

prepare:
  stage: prepare
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: alpine:latest
  script:
    - apk add libxml2-utils
    - echo "APP_VERSION=$(xmllint --xpath "//package/version/text()" lgdxrobot_cloud_adapter/package.xml)" >> variables.env
  artifacts:
    reports:
      dotenv: variables.env
    expire_in: 1 day

#
# Build LGDXRobot Cloud Adapter
#

build-amd64:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: docker:24.0.5-git
  needs:
    - job: prepare
      artifacts: true
  tags:
    - saas-linux-small-amd64
  services:
    - docker:24.0.5-dind
  variables:
    ARCH: amd64
  before_script:
    - apk add zip
  script:
    - git submodule update --init --recursive
    - docker build --build-arg APP_VERSION=$APP_VERSION -f Dockerfile -o . .
    - cd debs
    - zip -r lgdxrobot-cloud-adapter-$ARCH.zip *
  artifacts:
    paths:
      - debs/lgdxrobot-cloud-adapter-$ARCH.zip
    expire_in: 1 day

build-arm64:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: docker:24.0.5-git
  needs:
    - job: prepare
      artifacts: true
  tags:
    - saas-linux-small-arm64
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    ARCH: arm64
  services:
    - name: docker:24.0.5-dind
      command: ["--mtu=1400"]
  before_script:
    - apk add zip
  script:
    - git submodule update --init --recursive
    - docker build --build-arg APP_VERSION=$APP_VERSION -f Dockerfile -o . .
    - cd debs
    - zip -r lgdxrobot-cloud-adapter-$ARCH.zip *
  artifacts:
    paths:
      - debs/lgdxrobot-cloud-adapter-$ARCH.zip
    expire_in: 1 day

#
# Release
#
    
release:
  stage: release
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
      when: never 
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - job: prepare
      artifacts: true
    - job: build-amd64
      artifacts: true
    - job: build-arm64
      artifacts: true
  before_script:
    - apk add glab
    - apk add curl
  script:
    - cd debs
    - |
      curl --location --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file lgdxrobot-cloud-adapter-amd64.zip \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/LGDXRobot-Cloud-Adapter/$APP_VERSION/lgdxrobot-cloud-adapter-amd64.zip"
    - |
      curl --location --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file lgdxrobot-cloud-adapter-amd64.zip \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/LGDXRobot-Cloud-Adapter/latest/lgdxrobot-cloud-adapter-amd64.zip"
    - |
      curl --location --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file lgdxrobot-cloud-adapter-arm64.zip \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/LGDXRobot-Cloud-Adapter/$APP_VERSION/lgdxrobot-cloud-adapter-arm64.zip"
    - |
      curl --location --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file lgdxrobot-cloud-adapter-arm64.zip \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/LGDXRobot-Cloud-Adapter/latest/lgdxrobot-cloud-adapter-arm64.zip"
  release:
    name : '$APP_VERSION'
    tag_name: '$APP_VERSION'
    description: '$APP_VERSION'
    ref: '$CI_COMMIT_SHA'
    assets:
      links:
        - name: 'LGDXRobot Cloud Adapter .deb Packages for AMD64/x86-64'
          url: 'https://gitlab.com/api/v4/projects/79562400/packages/generic/LGDXRobot-Cloud-Adapter/$APP_VERSION/lgdxrobot-cloud-adapter-amd64.zip'
        - name: 'LGDXRobot Cloud Adapter .deb Packages for ARM64/AArch64'
          url: 'https://gitlab.com/api/v4/projects/79562400/packages/generic/LGDXRobot-Cloud-Adapter/$APP_VERSION/lgdxrobot-cloud-adapter-arm64.zip'


